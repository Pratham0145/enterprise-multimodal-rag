<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Multimedia RAG Chat</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: #0f172a;
    display: flex;
    flex-direction: column;
    height: 100vh;
    color: #e2e8f0;
}

.header {
    background: #1e293b;
    color: white;
    padding: 14px 20px;
    text-align: center;
    font-size: 17px;
    font-weight: bold;
    border-bottom: 1px solid #334155;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-links a {
    color: #38bdf8;
    font-size: 12px;
    text-decoration: none;
    margin-left: 12px;
    padding: 4px 10px;
    border: 1px solid #38bdf8;
    border-radius: 4px;
}

.header-links a:hover { background: #38bdf820; }

.chat-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.message {
    max-width: 78%;
    padding: 12px 16px;
    border-radius: 12px;
    line-height: 1.6;
    font-size: 14px;
}

.user {
    align-self: flex-end;
    background: #2563eb;
    color: white;
    border-radius: 12px 12px 4px 12px;
}

.bot {
    align-self: flex-start;
    background: #1e293b;
    color: #e2e8f0;
    border: 1px solid #334155;
    border-radius: 12px 12px 12px 4px;
}

.figure-block {
    margin-top: 12px;
    background: #0f172a;
    border: 1px solid #334155;
    border-radius: 8px;
    overflow: hidden;
}

.figure-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: #1e293b;
    border-bottom: 1px solid #334155;
    font-size: 12px;
}

.figure-badge {
    background: #0ea5e920;
    color: #38bdf8;
    border: 1px solid #0ea5e940;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 700;
    font-size: 11px;
}

.figure-block img {
    width: 100%;
    display: block;
    max-height: 340px;
    object-fit: contain;
    background: #fff;
}

.citation {
    font-size: 11px;
    margin-top: 10px;
    color: #64748b;
    padding-top: 8px;
    border-top: 1px solid #1e293b;
}

.input-area {
    display: flex;
    padding: 14px 20px;
    background: #1e293b;
    border-top: 1px solid #334155;
    gap: 10px;
}

textarea {
    flex: 1;
    resize: none;
    padding: 10px 14px;
    border-radius: 8px;
    border: 1px solid #334155;
    background: #0f172a;
    color: #e2e8f0;
    font-size: 14px;
    font-family: inherit;
}

textarea:focus { outline: none; border-color: #38bdf8; }

button {
    padding: 10px 22px;
    border-radius: 8px;
    border: none;
    background: #22c55e;
    color: white;
    cursor: pointer;
    font-weight: bold;
    font-size: 14px;
    white-space: nowrap;
}

button:hover { background: #16a34a; }
button:disabled { background: #374151; cursor: not-allowed; }

.loading {
    font-style: italic;
    color: #64748b;
}

.suggestions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 12px 20px;
    background: #0f172a;
    border-bottom: 1px solid #1e293b;
}

.suggestion-btn {
    padding: 5px 12px;
    background: #1e293b;
    border: 1px solid #334155;
    border-radius: 16px;
    color: #94a3b8;
    font-size: 12px;
    cursor: pointer;
}

.suggestion-btn:hover {
    background: #334155;
    color: #e2e8f0;
}
</style>
</head>
<body>

<div class="header">
    <span>ðŸš€ Multimedia Hybrid RAG Assistant</span>
    <div class="header-links">
        <a href="/health" target="_blank">Health</a>
        <a href="/debug-figures" target="_blank">Debug Figures</a>
    </div>
</div>

<div class="suggestions">
    <span style="font-size:12px;color:#475569;align-self:center;">Try:</span>
    <button class="suggestion-btn" onclick="fillQuery(this)">Show DGX-1 architecture diagram</button>
    <button class="suggestion-btn" onclick="fillQuery(this)">Show Tesla V100 diagram</button>
    <button class="suggestion-btn" onclick="fillQuery(this)">Show NVLink topology</button>
    <button class="suggestion-btn" onclick="fillQuery(this)">How many CUDA cores does V100 have?</button>
    <button class="suggestion-btn" onclick="fillQuery(this)">What is the GPU memory bandwidth?</button>
    <button class="suggestion-btn" onclick="fillQuery(this)">Compare NVLink vs PCIe performance</button>
</div>

<div class="chat-container" id="chat"></div>

<div class="input-area">
    <textarea id="query" placeholder="Ask about DGX-1 architecture..." rows="2"></textarea>
    <button id="send-btn" onclick="sendQuery()">Send</button>
</div>

<script>
function fillQuery(btn) {
    document.getElementById("query").value = btn.innerText;
    sendQuery();
}

async function sendQuery() {
    const queryInput = document.getElementById("query");
    const sendBtn    = document.getElementById("send-btn");
    const query      = queryInput.value.trim();
    if (!query) return;

    const chat = document.getElementById("chat");

    const userMsg = document.createElement("div");
    userMsg.className = "message user";
    userMsg.innerText = query;
    chat.appendChild(userMsg);

    queryInput.value = "";
    sendBtn.disabled = true;
    chat.scrollTop   = chat.scrollHeight;

    const loadingMsg = document.createElement("div");
    loadingMsg.className = "message bot loading";
    loadingMsg.innerText = "Searching document...";
    chat.appendChild(loadingMsg);
    chat.scrollTop = chat.scrollHeight;

    try {
        const res  = await fetch("/multimedia-rag", {
            method:  "POST",
            headers: {"Content-Type": "application/json"},
            body:    JSON.stringify({query}),
        });
        const data = await res.json();

        chat.removeChild(loadingMsg);

        const botMsg = document.createElement("div");
        botMsg.className = "message bot";

        if (data.error) {
            botMsg.innerText = "Error: " + data.error;
            chat.appendChild(botMsg);
            return;
        }

        // Answer text
        const answer = document.createElement("div");
        answer.innerText = data.answer;
        botMsg.appendChild(answer);

        // Images with figure label
        if (data.images && data.images.length > 0) {
            data.images.forEach((imgBase64, idx) => {
                const block = document.createElement("div");
                block.className = "figure-block";

                const header = document.createElement("div");
                header.className = "figure-header";

                const badge = document.createElement("span");
                badge.className = "figure-badge";

                // Try to extract figure number from answer text
                const figMatch = data.answer.match(/Figure\s+(\d+)/i);
                badge.innerText = figMatch ? "Figure " + figMatch[1] : "Figure";

                const pageInfo = document.createElement("span");
                pageInfo.style.color = "#64748b";
                pageInfo.style.fontSize = "11px";
                pageInfo.innerText = data.citations && data.citations.length > 0
                    ? "Pages: " + data.citations.join(", ")
                    : "";

                header.appendChild(badge);
                header.appendChild(pageInfo);
                block.appendChild(header);

                const img = document.createElement("img");
                img.src = "data:image/png;base64," + imgBase64;
                img.alt = "Figure from document";
                img.onerror = () => {
                    // Try jpeg if png fails
                    img.src = "data:image/jpeg;base64," + imgBase64;
                };
                block.appendChild(img);
                botMsg.appendChild(block);
            });
        }

        // Citations
        if (data.citations && data.citations.length > 0) {
            const citation = document.createElement("div");
            citation.className = "citation";
            citation.innerText = "Referenced pages: " + data.citations.join(", ");
            botMsg.appendChild(citation);
        }

        chat.appendChild(botMsg);

    } catch (err) {
        chat.removeChild(loadingMsg);
        const errorMsg = document.createElement("div");
        errorMsg.className = "message bot";
        errorMsg.innerText = "Connection error: " + err.message;
        chat.appendChild(errorMsg);
    } finally {
        sendBtn.disabled = false;
        chat.scrollTop   = chat.scrollHeight;
    }
}

document.getElementById("query").addEventListener("keydown", function(e) {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendQuery();
    }
});
</script>
</body>
</html>